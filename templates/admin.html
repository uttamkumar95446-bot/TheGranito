{% extends "base.html" %}

{% block title %}Admin Panel - Portfolio{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">Admin Dashboard</h1>
        <div class="badge bg-primary fs-6">
            Last updated: {{ moment().format('MMMM Do YYYY, h:mm a') }}
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ contacts|length }}</h4>
                            <p class="mb-0">Total Messages</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-envelope fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="visitorCount">0</h4>
                            <p class="mb-0">Total Visitors</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>5</h4>
                            <p class="mb-0">Active Projects</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-project-diagram fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="responseRate">98%</h4>
                            <p class="mb-0">Response Rate</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Messages -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">
                <i class="fas fa-inbox"></i> Contact Messages
                <span class="badge bg-light text-dark ms-2">{{ contacts|length }}</span>
            </h4>
        </div>
        <div class="card-body">
            {% if contacts %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contact in contacts %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <strong>{{ contact.name }}</strong>
                            </td>
                            <td>
                                <a href="mailto:{{ contact.email }}" class="text-decoration-none">
                                    {{ contact.email }}
                                </a>
                            </td>
                            <td>
                                <div class="message-preview">
                                    {{ contact.message[:100] }}
                                    {% if contact.message|length > 100 %}...{% endif %}
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ contact.timestamp }}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewMessage({{ loop.index0 }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="mailto:{{ contact.email }}" class="btn btn-outline-success">
                                        <i class="fas fa-reply"></i>
                                    </a>
                                    <button class="btn btn-outline-danger" onclick="deleteMessage({{ loop.index0 }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No messages yet</h4>
                <p class="text-muted">Contact messages will appear here when received.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Messages
                        </button>
                        <button class="btn btn-outline-success" onclick="refreshStats()">
                            <i class="fas fa-refresh"></i> Refresh Statistics
                        </button>
                        <button class="btn btn-outline-warning" onclick="clearOldMessages()">
                            <i class="fas fa-broom"></i> Clear Old Messages
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-feed">
                        <div class="activity-item">
                            <i class="fas fa-envelope text-primary"></i>
                            <span>New message received 2 hours ago</span>
                        </div>
                        <div class="activity-item">
                            <i class="fas fa-user text-success"></i>
                            <span>5 new visitors today</span>
                        </div>
                        <div class="activity-item">
                            <i class="fas fa-code text-info"></i>
                            <span>Portfolio updated yesterday</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Message content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="replyButton" href="#" class="btn btn-primary">Reply</a>
            </div>
        </div>
    </div>
</div>

<script>
const contacts = {{ contacts|tojson }};

// View message in modal
function viewMessage(index) {
    const contact = contacts[index];
    const modalBody = document.getElementById('messageModalBody');
    const replyButton = document.getElementById('replyButton');
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>Name:</strong> ${contact.name}
            </div>
            <div class="col-md-6">
                <strong>Email:</strong> ${contact.email}
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <strong>Date:</strong> ${contact.timestamp}
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <strong>Message:</strong>
                <div class="mt-2 p-3 bg-light rounded">
                    ${contact.message}
                </div>
            </div>
        </div>
    `;
    
    replyButton.href = `mailto:${contact.email}?subject=Re: Your inquiry`;
    
    new bootstrap.Modal(document.getElementById('messageModal')).show();
}

// Delete message
function deleteMessage(index) {
    if (confirm('Are you sure you want to delete this message?')) {
        // In a real application, this would make an API call
        alert('Message deleted successfully!');
        location.reload();
    }
}

// Export data
function exportData() {
    const dataStr = JSON.stringify(contacts, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'contacts.json';
    link.click();
}

// Refresh stats
function refreshStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('visitorCount').textContent = data.total_visitors;
            alert('Statistics refreshed!');
        })
        .catch(error => {
            alert('Error refreshing statistics');
        });
}

// Clear old messages
function clearOldMessages() {
    if (confirm('This will delete messages older than 30 days. Continue?')) {
        alert('Old messages cleared successfully!');
    }
}

// Load visitor count on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('visitorCount').textContent = data.total_visitors;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
});
</script>

<style>
.activity-feed .activity-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.activity-feed .activity-item i {
    margin-right: 10px;
    width: 20px;
}

.message-preview {
    max-width: 300px;
    word-wrap: break-word;
}
</style>
{% endblock %}
